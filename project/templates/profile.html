{% extends "layout.html" %}
{% from 'includes/pro_plans_cards.html' import render_pro_plans %}
{% block title %}{{ _('个人资料') }} - {{ _('南瓜AI') }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto pb-12">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
        <a href="{{ url_for('main.index') }}"
            class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">{{ _('设置与个人资料') }}</h1>
    </div>

    <div class="space-y-6">
        <!-- Info Banner -->
        <div class="bg-pumpkin-50 border border-pumpkin-100 rounded-2xl p-4 flex gap-3 animate-fade-in-up">
            <svg class="w-6 h-6 text-pumpkin-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm text-pumpkin-800 leading-relaxed">{{ _('请提供准确的个人信息。您的隐私对我们很重要，敏感信息将受到严格保护。') }}</p>
        </div>

        <!-- Pro Membership Card -->
        {% if pro_settings and pro_settings.enabled %}
        <div
            class="glass rounded-3xl overflow-hidden animate-fade-in-up delay-75 border-2 {% if user.is_pro %}border-yellow-400{% else %}border-gray-100{% endif %}">
            <div
                class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r {% if user.is_pro %}from-yellow-50 to-orange-50{% else %}from-gray-50 to-white{% endif %}">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    {{ _('Pro 会员') }}
                    {% if user.is_pro %}
                    <span class="bg-yellow-400 text-white text-xs px-2 py-0.5 rounded-full">ACTIVE</span>
                    {% endif %}
                </h2>
                {% if user.is_pro and user.membership_expiry %}
                <span class="text-sm font-bold text-gray-600">
                    {{ _('有效期至') }}: {{ user.membership_expiry[:10] }}
                </span>
                {% endif %}
            </div>
            <div class="p-6">
                {% if user.is_pro %}
                <!-- Active Pro View -->
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900">{{ _('尊贵的 Pro 会员') }}</h3>
                        <p class="text-sm text-gray-500">{{ _('您已解锁所有 Pro 会员权益。') }}</p>
                    </div>
                </div>

                <!-- Renewal Options (Kept separate as styling is different) -->
                <div class="mt-6 border-t border-gray-100 pt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">{{ _('会员续费') }}</h4>
                    {% set enabled_plans = (pro_plans | selectattr('enabled') | list) if pro_plans else [] %}
                    {% if enabled_plans %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% for plan in enabled_plans %}
                        {% if get_locale() == 'en' %}
                        <!-- English/USD Renewal -->
                        <div
                            class="relative group p-3 rounded-xl border border-gray-200 bg-white hover:border-pumpkin-300 hover:shadow-sm transition-all">
                            <div class="flex justify-between items-center mb-1">
                                <div class="font-bold text-gray-900">{{ plan.name }}</div>
                                <div class="text-right">
                                    {% if plan.original_price %}
                                    <div class="text-xs text-gray-400 line-through decoration-gray-400">${{
                                        plan.original_price }}</div>
                                    {% endif %}
                                    <div class="text-pumpkin-600 font-bold">${{ plan.price }}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mb-3">{{ plan.duration_days }} Days</div>
                            <a href="{{ plan.link or pro_settings.kofi_shop_link }}" target="_blank"
                                onclick="trackRechargeClick()"
                                class="block w-full text-center py-1.5 bg-gray-900 text-white text-xs font-bold rounded-lg group-hover:bg-pumpkin-500 transition-colors">
                                Renew Now
                            </a>
                        </div>
                        {% else %}
                        <!-- Chinese/CNY Renewal -->
                        <div
                            class="relative group p-3 rounded-xl border border-gray-200 bg-white hover:border-pumpkin-300 hover:shadow-sm transition-all">
                            <div class="flex justify-between items-center mb-1">
                                <div class="font-bold text-gray-900">{{ plan.name }}</div>
                                <div class="text-right">
                                    {% if plan.original_price_cny %}
                                    <div class="text-xs text-gray-400 line-through decoration-gray-400">¥{{
                                        plan.original_price_cny }}</div>
                                    {% endif %}
                                    <div class="text-pumpkin-600 font-bold">¥{{ plan.price_cny or '--' }}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mb-3">{{ plan.duration_days }} 天</div>
                            <button
                                onclick="openCnyPaymentModal('{{ plan.name }}', '{{ plan.price_cny }}', '{{ plan.alipay_qr_code }}', `{{ plan.cny_payment_instruction }}`)"
                                class="block w-full text-center py-1.5 bg-gray-900 text-white text-xs font-bold rounded-lg group-hover:bg-pumpkin-500 transition-colors">
                                立即续费
                            </button>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 bg-gray-50 rounded-xl">
                        <p class="text-sm text-gray-500">{{ _('暂无续费套餐') }}</p>
                    </div>
                    {% endif %}
                </div>

                {% else %}
                <!-- Upgrade to Pro View -->
                <div class="flex flex-col gap-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900">{{ _('升级到 Pro') }}</h3>
                            <p class="text-sm text-gray-500">
                                {% if get_locale() == 'en' %}
                                {{ pro_settings.task_description_en | default(pro_settings.task_description, true) |
                                default('Unlimited inference, dedicated GPU, and more premium features.', true) |
                                markdown | striptags }}
                                {% else %}
                                {{ pro_settings.task_description | default('无限次推理，专用 GPU，更多高级功能。', true) | markdown |
                                striptags }}
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {{ render_pro_plans(pro_plans, pro_settings, get_locale() != 'en', user) }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Promotion Mode Card (Only shown if Pro system is disabled AND Promotion mode is enabled) -->
        {% if pro_settings and not pro_settings.enabled and pro_settings.promotion_enabled %}
        <div class="glass rounded-3xl overflow-hidden animate-fade-in-up delay-75 border-2 {% if user.is_pro %}border-green-400{% else %}border-gray-100{% endif %}">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r {% if user.is_pro %}from-green-50 to-emerald-50{% else %}from-gray-50 to-white{% endif %}">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    {{ _('推广会员') }}
                    {% if user.is_pro %}
                    <span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full">ACTIVE</span>
                    {% endif %}
                </h2>
                {% if user.is_pro and user.membership_expiry %}
                <span class="text-sm font-bold text-gray-600">
                    {{ _('有效期至') }}: {{ user.membership_expiry[:10] }}
                </span>
                {% endif %}
            </div>

            <div class="p-6">
                {% if user.is_pro %}
                <!-- Active Promotion Member View -->
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900">{{ _('尊贵的南瓜推广会员') }}</h3>
                        <p class="text-sm text-gray-500">{{ _('感谢您的推广支持！您已获得与 Pro 会员同等的全部权益。') }}</p>
                    </div>
                </div>
                {% else %}
                <!-- Not yet member: Show Instructions + Form -->
                <div class="mb-6">
                    <div class="prose prose-sm text-gray-600 mb-4">
                        {{ pro_settings.promotion_benefits_html | safe }}
                    </div>
                </div>
                
                <div class="border-t border-gray-100 pt-6">
                    <h3 class="font-bold text-gray-900 mb-4">{{ _('提交推广证明') }}</h3>
                    
                    <!-- Check status of last submission -->
                    {% set pending_sub = none %}
                    {% for sub in user.promotion_submissions | default([]) %}
                        {% if sub.status == 'pending' %}
                            {% set pending_sub = sub %}
                        {% endif %}
                    {% endfor %}

                    <!-- Hacky way to get pending submission from injected user object if not loaded directly -->
                    <!-- Ideally backend injects this. For now let's assume user object has it or we use Alpine/Fetch to submit -->
                    
                    <form id="promotion-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('推广链接') }}</label>
                            <input type="url" name="link" required placeholder="https://..." class="w-full rounded-xl border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('截图证明') }}</label>
                            <input type="file" name="screenshot" accept="image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                        </div>
                        <div class="pt-2">
                            <button type="submit" id="promo-submit-btn" class="w-full py-2.5 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-colors shadow-md">
                                {{ _('提交审核') }}
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 text-center">{{ _('管理员将在 24 小时内审核您的提交。审核通过后自动发放会员。') }}</p>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        
        <script>
        document.getElementById('promotion-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('promo-submit-btn');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = '{{ _("提交中...") }}';
            
            try {
                const formData = new FormData(form);
                const response = await fetch('{{ url_for("api.submit_promotion") }}', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('{{ _("提交成功！请耐心等待管理员审核。") }}');
                    form.reset();
                    // Optionally reload to show pending state if backend renders it
                    // window.location.reload(); 
                } else {
                    alert('{{ _("提交失败: ") }}' + result.error);
                }
            } catch (err) {
                alert('{{ _("网络错误，请稍后重试。") }}');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
        </script>
        {% endif %}

        <!-- Basic Info Card -->
        <div class="glass rounded-3xl overflow-hidden animate-fade-in-up delay-100">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-bold text-gray-900">{{ _('基本信息') }}</h2>
            </div>
            <div class="p-6 space-y-6">
                <!-- Avatar -->
                <div class="flex items-center justify-between group">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('头像') }}</label>
                        <p class="text-xs text-gray-500">{{ _('点击更换头像') }}</p>
                    </div>
                    <div class="relative">
                        <img src="{{ user.avatar or url_for('static', filename='avatars/default.svg') }}"
                            id="avatar-preview-img" alt="Avatar"
                            class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md cursor-pointer transition-transform hover:scale-105 active:scale-95"
                            onclick="document.getElementById('change-avatar-btn').click()">
                        <button id="change-avatar-btn"
                            class="absolute bottom-0 right-0 p-1.5 bg-white rounded-full shadow-sm border border-gray-200 text-gray-600 hover:text-pumpkin-600 transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-50"></div>

                <!-- Username -->
                <div class="flex justify-between items-center py-2 group">
                    <span class="text-sm font-medium text-gray-700">{{ _('用户名') }}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold text-gray-900" id="current-username-display">{{
                            session.username }}</span>
                        <button onclick="document.getElementById('change-username-modal').classList.remove('hidden')"
                            class="text-xs text-pumpkin-600 hover:text-pumpkin-700 font-medium px-2 py-1 bg-pumpkin-50 rounded transition-colors">{{
                            _('修改') }}</button>
                    </div>
                </div>

                <div class="border-t border-gray-50"></div>

                <!-- Email Binding -->
                <div class="py-2 group">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">{{ _('绑定邮箱') }}</span>
                        {% if user.email %}
                        <span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-0.5 rounded-full">{{
                            _('已绑定') }}</span>
                        {% else %}
                        <span class="text-xs text-gray-400 font-medium">{{ _('未绑定') }}</span>
                        {% endif %}
                    </div>
                    <div class="flex gap-2">
                        <input type="email" id="bind-email-input" value="{{ user.email or '' }}"
                            placeholder="{{ _('输入邮箱地址') }}"
                            class="flex-1 text-sm border-gray-200 rounded-lg focus:ring-pumpkin-500 focus:border-pumpkin-500 bg-gray-50/50"
                            {% if user.email %}readonly{% endif %}>
                        <button onclick="bindEmail()" id="bind-email-btn"
                            class="px-4 py-2 bg-gray-900 text-white text-xs font-bold rounded-lg hover:bg-black transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                            {% if user.email %}disabled{% endif %}>
                            {{ _('已绑定') if user.email else _('绑定') }}
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">{{ _('每个账号只能绑定唯一的邮箱，绑定后可用于接收通知和充值验证。') }}</p>
                </div>

                <div class="border-t border-gray-50"></div>

                <!-- GitHub Binding -->
                <div class="py-2 group">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">{{ _('绑定 GitHub') }}</span>
                        {% if user.is_github_user %}
                        <span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-0.5 rounded-full">{{
                            _('已绑定') }}</span>
                        {% else %}
                        <span class="text-xs text-gray-400 font-medium">{{ _('未绑定') }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-between">
                        {% if user.is_github_user %}
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                            </svg>
                            <span class="text-sm text-gray-600 font-medium">{{ user.github_original_login or 'GitHub 用户'
                                }}</span>
                        </div>
                        <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-lg">支持一键登录</span>
                        {% else %}
                        <p class="text-xs text-gray-500 flex-1">绑定后可使用 GitHub 一键登录，部分功能需要绑定 GitHub。</p>
                        <a href="{{ url_for('auth.github_bind') }}"
                            class="px-4 py-2 bg-blue-500 text-white text-xs font-bold rounded-lg hover:bg-blue-600 transition-colors shadow-sm hover:shadow-md ml-3"
                            style="background: linear-gradient(135deg, #0969da, #1f6feb); text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                            去绑定
                        </a>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-gray-50"></div>

                <!-- API Key -->
                <div class="py-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">{{ _('API 密钥') }}</span>
                        <button onclick="copyToClipboard('{{ user.api_key }}')"
                            class="text-xs font-bold text-pumpkin-600 hover:text-pumpkin-700 px-2 py-1 rounded bg-pumpkin-50 hover:bg-pumpkin-100 transition-colors">
                            {{ _('复制') }}
                        </button>
                    </div>
                    <div class="relative">
                        <input type="text" value="{{ api_key }}" readonly
                            class="w-full text-sm font-mono text-gray-500 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none select-all">
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Check-in Card -->
        <div x-data="calendar()" x-init="init()" class="glass rounded-3xl overflow-hidden animate-fade-in-up delay-150">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-bold text-gray-900">{{ _('每日签到') }}</h2>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <button @click="prevMonth()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                    </button>
                    <h3 class="text-lg font-semibold text-gray-800" x-text="monthYear"></h3>
                    <button @click="nextMonth()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-sm text-gray-500 mb-2">
                    <template x-for="day in weekDays" :key="day">
                        <div x-text="day"></div>
                    </template>
                </div>
                <div class="grid grid-cols-7 gap-2">
                    <template x-for="day in daysInMonth" :key="day.date">
                        <div class="flex items-center justify-center h-10 w-10 rounded-full" :class="{
                                'bg-pumpkin-500 text-white shadow-lg': day.isToday && day.isChecked,
                                'ring-2 ring-pumpkin-500': day.isToday && !day.isChecked,
                                'bg-green-100 text-green-700': !day.isToday && day.isChecked,
                                'text-gray-300': !day.isCurrentMonth,
                                'text-gray-800': day.isCurrentMonth
                             }">
                            <span x-text="day.day"></span>
                        </div>
                    </template>
                </div>
                <div class="mt-6">
                    <button @click="performCheckIn()" :disabled="isCheckedInToday && !adsEnabled"
                        class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold transition-all active:scale-95"
                        :class="{
                                'text-white bg-gray-900 hover:bg-black': !(isCheckedInToday && !adsEnabled),
                                'bg-gray-200 text-gray-500 cursor-not-allowed': isCheckedInToday && !adsEnabled
                            }">
                        <span x-show="!isLoading"
                            x-text="isCheckedInToday ? '{{ _('今日已签到') }}' : '{{ _('立即签到') }}'"></span>
                        <svg x-show="isLoading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </button>
                    <p x-show="message" x-text="message" class="text-xs mt-2 text-center"
                        :class="isError ? 'text-red-500' : 'text-green-600'"></p>
                </div>
            </div>
        </div>


        <!-- Security Card -->
        <div class="glass rounded-3xl overflow-hidden animate-fade-in-up delay-200">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-bold text-gray-900">{{ _('安全设置') }}</h2>
            </div>
            <div class="p-6">
                <form method="post" action="{{ url_for('main.change_password') }}" class="space-y-4">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">{{ _('当前密码')
                            }}</label>
                        <input type="password" id="current_password" name="current_password" required
                            class="w-full text-sm border-gray-200 rounded-xl focus:ring-pumpkin-500 focus:border-pumpkin-500 bg-gray-50/50">
                    </div>
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">{{ _('新密码')
                            }}</label>
                        <input type="password" id="new_password" name="new_password" required
                            class="w-full text-sm border-gray-200 rounded-xl focus:ring-pumpkin-500 focus:border-pumpkin-500 bg-gray-50/50">
                    </div>
                    <div>
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">{{ _('确认新密码')
                            }}</label>
                        <input type="password" id="confirm_password" name="confirm_password" required
                            class="w-full text-sm border-gray-200 rounded-xl focus:ring-pumpkin-500 focus:border-pumpkin-500 bg-gray-50/50">
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold text-white bg-gray-900 hover:bg-black focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-all active:scale-95">
                            {{ _('更新密码') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Change Username Modal -->
<div id="change-username-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4"
    style="background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px);">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 animate-fade-in-up">
        <h3 class="text-xl font-bold text-gray-900 mb-4">{{ _('修改用户名') }}</h3>
        <p class="text-sm text-gray-500 mb-6">{{ _('用户名每 30 天只能修改一次。修改后需要使用新用户名登录。') }}</p>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('新用户名') }}</label>
                <input type="text" id="new-username-input"
                    class="w-full border-gray-200 rounded-xl focus:ring-pumpkin-500 focus:border-pumpkin-500"
                    placeholder="{{ _('3-20个字符，仅限字母数字下划线') }}">
            </div>

            <div id="username-change-error" class="text-xs text-red-500 hidden"></div>

            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('change-username-modal').classList.add('hidden')"
                    class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">{{
                    _('取消') }}</button>
                <button onclick="submitUsernameChange()"
                    class="flex-1 px-4 py-2 bg-pumpkin-500 text-white rounded-xl font-bold hover:bg-pumpkin-600 transition-colors">{{
                    _('确认修改') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal (Glassmorphism) -->
<div id="file-browser-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 sm:p-6"
    style="background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px);">
    <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden animate-fade-in-up">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white/80 backdrop-blur-md">
            <h2 class="text-lg font-bold text-gray-900">{{ _('选择头像') }}</h2>
            <button
                class="close-button text-gray-400 hover:text-gray-900 transition-colors rounded-full p-1 hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto bg-gray-50/50 flex-1">
            <div id="file-browser-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- File list loaded here -->
                <div class="col-span-full flex justify-center py-10">
                    <div class="w-8 h-8 border-4 border-pumpkin-200 border-t-pumpkin-500 rounded-full animate-spin">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function bindEmail() {
        const input = document.getElementById('bind-email-input');
        const btn = document.getElementById('bind-email-btn');
        const email = input.value.trim();

        if (!email) {
            alert('请输入邮箱地址');
            return;
        }

        if (!confirm('确定要绑定此邮箱吗？绑定后将无法轻易更改。')) {
            return;
        }

        btn.disabled = true;
        btn.textContent = '处理中...';

        try {
            const formData = new FormData();
            formData.append('email', email);

            const response = await fetch('{{ url_for("main.bind_email") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert('邮箱绑定成功！');
                window.location.reload();
            } else {
                alert('绑定失败: ' + result.error);
                btn.disabled = false;
                btn.textContent = '绑定';
            }
        } catch (e) {
            alert('请求出错，请稍后重试');
            btn.disabled = false;
            btn.textContent = '绑定';
        }
    }

    async function submitUsernameChange() {
        const input = document.getElementById('new-username-input');
        const errorDiv = document.getElementById('username-change-error');
        const newUsername = input.value.trim();

        if (!newUsername) return;

        try {
            const formData = new FormData();
            formData.append('new_username', newUsername);

            const response = await fetch('{{ url_for("main.change_username") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert('用户名修改成功！');
                window.location.reload();
            } else {
                errorDiv.textContent = result.error;
                errorDiv.classList.remove('hidden');
            }
        } catch (e) {
            errorDiv.textContent = '请求失败，请稍后重试';
            errorDiv.classList.remove('hidden');
        }
    }

    function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(function () {
            // Create a temporary toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm font-medium animate-fade-in-up';
            toast.textContent = '已复制到剪贴板';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }, function (err) {
            alert('无法复制: ' + err);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('file-browser-modal');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const closeBtn = document.querySelector('.close-button');
        const fileListContainer = document.getElementById('file-browser-list');

        changeAvatarBtn.addEventListener('click', async () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            fileListContainer.innerHTML = '<div class="col-span-full flex justify-center py-10"><div class="w-8 h-8 border-4 border-pumpkin-200 border-t-pumpkin-500 rounded-full animate-spin"></div></div>';

            try {
                const response = await fetch('{{ url_for("api.list_my_s3_files") }}');
                const data = await response.json();
                if (data.success) {
                    renderFileList(data.files.filter(f => f.is_image));
                } else {
                    fileListContainer.innerHTML = `<div class="col-span-full text-center text-red-500 p-4 bg-red-50 rounded-xl border border-red-100">无法加载: ${data.error}</div>`;
                }
            } catch (error) {
                fileListContainer.innerHTML = `<div class="col-span-full text-center text-red-500 p-4 bg-red-50 rounded-xl border border-red-100">出错: ${error.message}</div>`;
            }
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        function renderFileList(files) {
            if (files.length === 0) {
                fileListContainer.innerHTML = `
                <div class="col-span-full text-center py-12 flex flex-col items-center text-gray-400">
                    <svg class="w-12 h-12 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p>您还没有生成图片</p>
                    <p class="text-xs mt-1">去创作一些AI作品吧！</p>
                </div>`;
                return;
            }
            fileListContainer.innerHTML = '';
            files.forEach(file => {
                const fileItem = document.createElement('div');
                // Tailwind classes for the item
                fileItem.className = 'group relative aspect-square rounded-xl overflow-hidden cursor-pointer border border-gray-200 bg-white shadow-sm hover:shadow-md transition-all';
                fileItem.dataset.key = file.key;
                fileItem.dataset.url = file.preview_url;

                fileItem.innerHTML = `
                <img src="${file.preview_url}" alt="${file.filename}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <span class="text-white text-xs font-bold border border-white/50 px-2 py-1 rounded-full backdrop-blur-sm">选择</span>
                </div>
            `;
                fileListContainer.appendChild(fileItem);
            });
        }

        fileListContainer.addEventListener('click', async (event) => {
            const fileItem = event.target.closest('.group'); // .group is the container class
            if (fileItem) {
                const fileKey = fileItem.dataset.key;

                // Show loading state on the clicked item
                const originalContent = fileItem.innerHTML;
                fileItem.innerHTML = '<div class="absolute inset-0 flex items-center justify-center bg-white/80 z-10"><div class="w-6 h-6 border-2 border-pumpkin-500 border-t-transparent rounded-full animate-spin"></div></div>' + originalContent;

                try {
                    const response = await fetch('{{ url_for("main.set_avatar") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ s3_key: fileKey }),
                    });
                    const result = await response.json();
                    if (result.success) {
                        const newAvatarUrl = result.new_avatar_url;

                        // Update all avatar instances on the page
                        document.getElementById('avatar-preview-img').src = newAvatarUrl;
                        const headerAvatar = document.querySelector('header img.rounded-full');
                        if (headerAvatar) headerAvatar.src = newAvatarUrl;
                        const mobileAvatar = document.querySelector('nav.fixed img');
                        if (mobileAvatar) mobileAvatar.src = newAvatarUrl;

                        modal.classList.add('hidden');
                        modal.classList.remove('flex');

                        // Success toast
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-full shadow-lg z-[200] text-sm font-medium animate-fade-in-up';
                        toast.textContent = '头像更新成功';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2000);

                    } else {
                        fileItem.innerHTML = originalContent; // Revert loading
                        alert('失败: ' + result.error);
                    }
                } catch (error) {
                    fileItem.innerHTML = originalContent; // Revert loading
                    alert('出错: ' + error.message);
                }
            }
        });
    });

    function calendar() {
        return {
            month: 0,
            year: 0,
            monthYear: '',
            daysInMonth: [],
            weekDays: ['日', '一', '二', '三', '四', '五', '六'],
            checkInHistory: {{ user.check_in_history | default([]) | tojson }},
            isCheckedInToday: false,
            isLoading: false,
            message: '',
            isError: false,
            today: '{{ today_str }}',
            adsEnabled: {{ settings.ads_enabled | tojson }},
    adUrl: 'https://www.effectivegatecpm.com/a3ytbz0m5?key=1c9add0be59c6b5d82f3baa7efd97980',

        init() {
        const serverToday = new Date(this.today + 'T00:00:00'); // Treat the server date as local
        this.month = serverToday.getMonth();
        this.year = serverToday.getFullYear();
        this.generateCalendar();
        this.checkIfCheckedInToday();
    },

    generateCalendar() {
        const firstDay = new Date(this.year, this.month, 1);
        const lastDay = new Date(this.year, this.month + 1, 0);
        const today = new Date(this.today + 'T00:00:00');

        this.monthYear = `${this.year}年${String(this.month + 1).padStart(2, '0')}月`;

        let days = [];

        // Add days from previous month
        for (let i = firstDay.getDay(); i > 0; i--) {
            const prevDate = new Date(this.year, this.month, 0 - i + 1);
            days.push({
                day: prevDate.getDate(),
                date: prevDate.toISOString().slice(0, 10),
                isCurrentMonth: false,
                isToday: false,
                isChecked: false
            });
        }

        // Add days for current month
        for (let i = 1; i <= lastDay.getDate(); i++) {
            const currentDate = new Date(this.year, this.month, i);
            const dateStr = currentDate.toISOString().slice(0, 10);
            days.push({
                day: i,
                date: dateStr,
                isCurrentMonth: true,
                isToday: today.getFullYear() === this.year && today.getMonth() === this.month && today.getDate() === i,
                isChecked: this.checkInHistory.includes(dateStr)
            });
        }

        // Add days for next month
        const remaining = 42 - days.length; // 6 rows * 7 days
        for (let i = 1; i <= remaining; i++) {
            const nextDate = new Date(this.year, this.month + 1, i);
            days.push({
                day: nextDate.getDate(),
                date: nextDate.toISOString().slice(0, 10),
                isCurrentMonth: false,
                isToday: false,
                isChecked: false
            });
        }

        this.daysInMonth = days;
    },

    prevMonth() {
        if (this.month === 0) {
            this.month = 11;
            this.year--;
        } else {
            this.month--;
        }
        this.generateCalendar();
    },

    nextMonth() {
        if (this.month === 11) {
            this.month = 0;
            this.year++;
        } else {
            this.month++;
        }
        this.generateCalendar();
    },

    getTodayString() {
        return this.today;
    },

    checkIfCheckedInToday() {
        this.isCheckedInToday = this.checkInHistory.includes(this.today);
    },

        async performCheckIn() {
        // If already checked in, just open the ad link if enabled
        if (this.isCheckedInToday) {
            if (this.adsEnabled) {
                window.open(this.adUrl, '_blank');
            }
            return;
        }

        // If not checked in, perform the check-in process
        this.isLoading = true;
        this.message = '';
        this.isError = false;

        try {
            const response = await fetch('{{ url_for("main.check_in") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                this.message = data.message || '签到成功！';
                const todayStr = this.getTodayString();
                if (!this.checkInHistory.includes(todayStr)) {
                    this.checkInHistory.push(todayStr);
                }
                this.checkIfCheckedInToday();
                this.generateCalendar(); // Re-render to show new check-in

                // Open ad link if ads are enabled
                if (this.adsEnabled) {
                    window.open(this.adUrl, '_blank');
                }
            } else {
                this.isError = true;
                this.message = data.error || '签到失败，请重试。';
            }
        } catch (error) {
            this.isError = true;
            this.message = '网络错误，请稍后重试。';
        } finally {
            this.isLoading = false;
            setTimeout(() => { this.message = '' }, 3000);
        }
    }
    }
}
</script>
{% endblock %}