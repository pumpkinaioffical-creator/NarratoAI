{% extends "layout.html" %}
{% block title %}ç½‘ç›˜ä¸­å¿ƒ{% endblock %}
{% block content %}
<style>
    .drive-page {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .drive-card {
        background: var(--system-background);
        border: 1px solid var(--separator-color);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.05);
    }
    .drive-hero {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .drive-hero h1 {
        margin: 0;
        font-size: 28px;
    }
    .drive-hero .lead {
        color: var(--secondary-text);
    }
    .drive-hero-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    .drive-hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(255, 117, 24, 0.08);
        color: var(--link-color);
        font-weight: 600;
        font-size: 14px;
    }
    .drive-panels {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(280px, 1fr);
        gap: 24px;
    }
    .drive-toolbar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
    }
    .drive-toolbar-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .drive-toolbar input[type="text"] {
        flex: 1;
        min-width: 200px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--separator-color);
        background: var(--system-background-secondary);
    }
    .drive-toolbar input[type="file"] {
        padding: 8px;
        border: 1px dashed var(--separator-color);
        border-radius: 8px;
        background: #fff;
    }
    .drive-status {
        font-size: 13px;
        color: var(--secondary-text);
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
    }
    .drive-status strong {
        color: var(--primary-text);
    }
    .drive-table-container {
        overflow: auto;
    }
    .drive-table {
        width: 100%;
        border-collapse: collapse;
    }
    .drive-table th,
    .drive-table td {
        padding: 12px;
        border-bottom: 1px solid var(--separator-color);
        text-align: left;
    }
    .drive-table tr:last-child td {
        border-bottom: none;
    }
    .drive-table .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .drive-table-empty {
        text-align: center;
        padding: 40px 0;
        color: var(--secondary-text);
    }
    .drive-chip {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--system-background-secondary);
        color: var(--secondary-text);
    }
    .drive-alert {
        border: 1px dashed rgba(255, 117, 24, 0.4);
        background: rgba(255, 117, 24, 0.05);
    }
    .drive-legacy h3 {
        margin-top: 0;
    }
    .drive-legacy p {
        color: var(--secondary-text);
    }
    .drive-badge-green {
        background: rgba(0, 200, 83, 0.1);
        color: #0f9d58;
    }
    .share-duration-label {
        display: flex;
        flex-direction: column;
        font-size: 13px;
        color: var(--secondary-text);
    }
    .share-duration-label select {
        margin-top: 4px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--separator-color);
    }
    .share-expire {
        display: inline-block;
        font-size: 12px;
        color: var(--secondary-text);
    }
    @media (max-width: 900px) {
        .drive-panels {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="drive-page">
    <section class="drive-card drive-hero">
        <span class="drive-hero-badge">âˆ æ— é™å®¹é‡ç½‘ç›˜</span>
        <h1>ç½‘ç›˜æ§åˆ¶ä¸­å¿ƒ</h1>
        <p class="lead">è¿™é‡Œé›†æˆäº†å…¨æ–°çš„æ— é™å®¹é‡ç½‘ç›˜ä»¥åŠå†å²çš„ S3ã€Œæˆ‘çš„æ–‡ä»¶ã€ã€‚æ¯ä½ç”¨æˆ·éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå®Œå…¨éš”ç¦»çš„æ ¹ç›®å½•ï¼Œæ‰€æœ‰è¯·æ±‚å‡ç”±æœåŠ¡å™¨å¸¦ç€å¯†é’¥ä»£ç†ï¼Œæœç»å…¬å¼€è®¿é—®é£é™©ã€‚</p>
        <div class="drive-hero-actions">
            <a href="{{ url_for('results.my_results') }}" class="btn btn-secondary">æ—§ç‰ˆ S3 ç½‘ç›˜</a>
            {% if modal_drive_url %}
            <a href="{{ modal_drive_url }}" target="_blank" class="btn btn-primary">ç›´æ¥æ‰“å¼€æ— é™å®¹é‡ç½‘ç›˜</a>
            {% endif %}
        </div>
        {% if drive_root %}
        <div class="drive-chip drive-badge-green">å½“å‰æ ¹ç›®å½•ï¼š/{{ drive_root }}/</div>
        {% endif %}
    </section>

    {% if not drive_enabled %}
    <section class="drive-card drive-alert">
        <h3>æ— é™å®¹é‡ç½‘ç›˜å°šæœªé…ç½®</h3>
        <p>è¯·å‰å¾€ã€Œç®¡ç†é¢æ¿ â†’ æ— é™å®¹é‡ç½‘ç›˜è®¾ç½®ã€å¡«å†™éƒ¨ç½²åœ°å€å’Œ Tokenï¼Œæˆ–è”ç³»ç®¡ç†å‘˜å¤„ç†ã€‚é…ç½®å®Œæˆååˆ·æ–°æœ¬é¡µé¢å³å¯ä½“éªŒæ— é™å®¹é‡ç½‘ç›˜ã€‚</p>
    </section>
    {% else %}
    <section class="drive-card drive-panel">
        <div class="drive-toolbar">
            <div class="drive-toolbar-row">
                <input type="file" id="drive-file-input">
                <input type="text" id="drive-path-input" placeholder="ä¿å­˜è·¯å¾„ï¼Œä¾‹å¦‚ assets/video.mp4">
                <button class="btn btn-primary" id="drive-upload-btn">ä¸Šä¼ </button>
            </div>
            <div class="drive-toolbar-row">
                <input type="text" id="drive-folder-input" placeholder="åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ datasets/2024">
                <button class="btn" id="drive-mkdir-btn">æ–°å»ºæ–‡ä»¶å¤¹</button>
                <button class="btn btn-secondary" id="drive-refresh-btn">åˆ·æ–°</button>
                <label class="share-duration-label">
                    åˆ†äº«æœ‰æ•ˆæœŸ
                    <select id="share-duration">
                        <option value="604800">7 å¤©</option>
                        <option value="2592000">30 å¤©</option>
                        <option value="31536000">365 å¤©</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="drive-status">
            <span id="drive-status-text">æ­£åœ¨åˆå§‹åŒ–...</span>
            <span class="drive-chip">æœåŠ¡ç«¯ä»£ç† Â· Token å®‰å…¨</span>
        </div>
        <div class="drive-table-container">
            <table class="drive-table" id="drive-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">ç±»å‹</th>
                        <th>è·¯å¾„</th>
                        <th style="width: 120px;">å¤§å°</th>
                        <th style="width: 170px;">æ›´æ–°æ—¶é—´</th>
                        <th style="width: 220px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="drive-table-empty">æ­£åœ¨åŠ è½½...</td></tr>
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}

    <section class="drive-card drive-legacy">
        <h3>æ—§ç‰ˆ S3ã€Œæˆ‘çš„æ–‡ä»¶ã€ä»ç„¶å¯ç”¨</h3>
        <p>åŸæœ‰çš„ S3 ç½‘ç›˜ä¸ä¼šä¸‹çº¿ï¼Œä¾æ—§å¯ä»¥æµè§ˆç”Ÿæˆè®°å½•ã€é‡å‘½åæ–‡ä»¶ä»¥åŠåˆ©ç”¨é¢„ç­¾åé“¾æ¥å¯¹æ¥å…¶ä»–æœåŠ¡ã€‚</p>
        <a href="{{ url_for('results.my_results') }}" class="btn btn-secondary">è¿›å…¥ S3 ç½‘ç›˜</a>
    </section>
</div>

{% if drive_enabled %}
<script>
(function() {
    const endpoints = {
        all: "{{ url_for('api.modal_drive_all') }}",
        upload: "{{ url_for('api.modal_drive_upload') }}",
        mkdir: "{{ url_for('api.modal_drive_mkdir') }}",
        rename: "{{ url_for('api.modal_drive_rename') }}",
        delete: "{{ url_for('api.modal_drive_delete') }}",
        download: "{{ url_for('results.modal_drive_download') }}",
        shareCreate: "{{ url_for('api.modal_drive_create_share') }}",
        shareDelete: "{{ url_for('api.modal_drive_delete_share') }}",
        shareList: "{{ url_for('api.modal_drive_list_shares') }}"
    };

    const tableBody = document.querySelector('#drive-table tbody');
    const statusText = document.getElementById('drive-status-text');
    const uploadBtn = document.getElementById('drive-upload-btn');
    const refreshBtn = document.getElementById('drive-refresh-btn');
    const mkdirBtn = document.getElementById('drive-mkdir-btn');
    const fileInput = document.getElementById('drive-file-input');
    const pathInput = document.getElementById('drive-path-input');
    const folderInput = document.getElementById('drive-folder-input');
    const durationSelect = document.getElementById('share-duration');
    let shareMap = {};
    let currentItems = [];

    function setStatus(message, tone = 'info') {
        statusText.textContent = message;
        statusText.style.color = tone === 'error' ? '#d93025'
            : tone === 'success' ? '#0f9d58'
            : 'var(--secondary-text)';
    }

    function fmtSize(bytes) {
        if (!bytes) return '--';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 1) + ' ' + units[i];
    }

    function renderRows(items) {
        currentItems = items || [];
        if (!items || !items.length) {
            tableBody.innerHTML = '<tr><td colspan="5" class="drive-table-empty">æš‚æ— æ–‡ä»¶ï¼Œä¸Šä¼ ä¸€ä¸ªè¯•è¯•å§ã€‚</td></tr>';
            return;
        }
        const rows = items.map(item => {
            const icon = item.is_dir ? 'ğŸ“' : 'ğŸ“„';
            const label = item.is_dir && item.path ? `${item.path}/` : (item.path || '/');
            const downloadBtn = item.is_dir ? '' :
                `<a class="btn btn-primary btn-sm" href="${endpoints.download}?path=${encodeURIComponent(item.path)}" target="_blank">ä¸‹è½½</a>`;
            const shared = Boolean(shareMap[item.path]);
            const shareLabel = shared ? 'å¤åˆ¶é“¾æ¥' : 'ç”Ÿæˆé“¾æ¥';
            const disableShare = item.is_dir ? 'disabled' : '';
            const disableUnshare = shared ? '' : 'disabled';
            const expiresAt = shared && shareMap[item.path].expires_at ? new Date(shareMap[item.path].expires_at * 1000).toLocaleDateString() : '';
            const expireBadge = expiresAt ? `<span class="share-expire">åˆ°æœŸ: ${expiresAt}</span>` : '';
            return `
                <tr data-path="${item.path || ''}" data-is-dir="${item.is_dir}">
                    <td>${icon}</td>
                    <td>${label}</td>
                    <td>${item.is_dir ? '--' : fmtSize(item.size)}</td>
                    <td>${new Date(item.mtime * 1000).toLocaleString()}</td>
                    <td>
                        <div class="actions">
                            ${downloadBtn}
                            <button class="btn btn-secondary btn-sm" data-action="rename">é‡å‘½å</button>
                            <button class="btn btn-secondary btn-sm" data-action="share" ${disableShare}>${shareLabel}</button>
                            <button class="btn btn-secondary btn-sm" data-action="unshare" ${disableUnshare}>å–æ¶ˆåˆ†äº«</button>
                            <button class="btn btn-secondary btn-sm" data-action="delete">åˆ é™¤</button>
                            ${expireBadge}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        tableBody.innerHTML = rows;
    }

    async function refreshList() {
        setStatus('æ­£åœ¨åŒæ­¥æœ€æ–°æ–‡ä»¶...', 'info');
        try {
            const [filesResponse, shareResponse] = await Promise.all([
                fetch(endpoints.all),
                fetch(endpoints.shareList)
            ]);
            const filesData = await filesResponse.json();
            if (!filesResponse.ok || !filesData.success) {
                throw new Error(filesData.error || 'åŠ è½½å¤±è´¥');
            }
            const sharesData = shareResponse.ok ? await shareResponse.json() : {success: false};
            shareMap = sharesData.success ? (sharesData.shares || {}) : {};
            renderRows(filesData.items || []);
            setStatus(`${(filesData.items || []).length} é¡¹ Â· åˆ·æ–°äº ${new Date().toLocaleTimeString()}`, 'success');
        } catch (error) {
            console.error(error);
            setStatus(error.message || 'åŠ è½½å¤±è´¥', 'error');
        }
    }

    async function uploadFile() {
        const file = fileInput.files[0];
        if (!file) {
            setStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
            return;
        }
        const saveAs = (pathInput.value || file.name).trim();
        if (!saveAs) {
            setStatus('è¯·è¾“å…¥ä¿å­˜è·¯å¾„', 'error');
            return;
        }
        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', saveAs);
        setStatus('æ­£åœ¨ä¸Šä¼ ...', 'info');
        uploadBtn.disabled = true;
        try {
            const res = await fetch(endpoints.upload, { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
            }
            setStatus(data.message || 'ä¸Šä¼ æˆåŠŸ', 'success');
            fileInput.value = '';
            pathInput.value = '';
            refreshList();
        } catch (error) {
            console.error(error);
            setStatus(error.message || 'ä¸Šä¼ å¤±è´¥', 'error');
        } finally {
            uploadBtn.disabled = false;
        }
    }

    async function createFolder() {
        const folder = folderInput.value.trim();
        if (!folder) {
            setStatus('è¯·è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„', 'error');
            return;
        }
        setStatus('æ­£åœ¨åˆ›å»ºæ–‡ä»¶å¤¹...', 'info');
        mkdirBtn.disabled = true;
        try {
            const res = await fetch(endpoints.mkdir, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ path: folder })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
            }
            setStatus(data.message || 'å·²åˆ›å»ºæ–‡ä»¶å¤¹', 'success');
            folderInput.value = '';
            refreshList();
        } catch (error) {
            console.error(error);
            setStatus(error.message || 'åˆ›å»ºå¤±è´¥', 'error');
        } finally {
            mkdirBtn.disabled = false;
        }
    }

    tableBody.addEventListener('click', async (event) => {
        const action = event.target.dataset.action;
        if (!action) return;
        const row = event.target.closest('tr');
        if (!row) return;
        const path = row.dataset.path;
        if (!path) {
            setStatus('æ— æ³•è·å–è·¯å¾„', 'error');
            return;
        }
        if (action === 'rename') {
            const newPath = prompt('è¯·è¾“å…¥æ–°çš„è·¯å¾„/åç§°', path);
            if (!newPath || newPath === path) {
                return;
            }
            setStatus('æ­£åœ¨é‡å‘½å...', 'info');
            try {
                const res = await fetch(endpoints.rename, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path, new_path: newPath })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'é‡å‘½åå¤±è´¥');
                }
                setStatus(data.message || 'å·²é‡å‘½å', 'success');
                refreshList();
            } catch (error) {
                console.error(error);
                setStatus(error.message || 'é‡å‘½åå¤±è´¥', 'error');
            }
        } else if (action === 'delete') {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€Œ${path}ã€å—ï¼Ÿ`)) {
                return;
            }
            setStatus('æ­£åœ¨åˆ é™¤...', 'info');
            try {
                const res = await fetch(`${endpoints.delete}?path=${encodeURIComponent(path)}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                }
                setStatus(data.message || 'å·²åˆ é™¤', 'success');
                refreshList();
            } catch (error) {
                console.error(error);
                setStatus(error.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } else if (action === 'share') {
            await handleShare(path, row.dataset.isDir === 'true');
        } else if (action === 'unshare') {
            await handleUnshare(path);
        }
    });

    async function handleShare(path, isDir) {
        if (isDir) {
            setStatus('æš‚ä¸æ”¯æŒåˆ†äº«æ–‡ä»¶å¤¹', 'error');
            return;
        }
        const existing = shareMap[path];
        if (existing) {
            await copyShareLink(existing.url);
            return;
        }
        setStatus('æ­£åœ¨ç”Ÿæˆåˆ†äº«é“¾æ¥...', 'info');
        try {
            const duration = parseInt(durationSelect.value, 10) || 604800;
            const res = await fetch(endpoints.shareCreate, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ path, duration })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
            }
            shareMap[path] = { token: data.token, url: data.url, expires_at: data.expires_at };
            renderRows(currentItems);
            await copyShareLink(data.url);
        } catch (error) {
            console.error(error);
            setStatus(error.message || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥', 'error');
        }
    }

    async function handleUnshare(path) {
        const existing = shareMap[path];
        if (!existing) {
            setStatus('è¯¥æ–‡ä»¶å°šæœªåˆ†äº«', 'info');
            return;
        }
        if (!confirm('ç¡®å®šè¦å–æ¶ˆè¯¥æ–‡ä»¶çš„åˆ†äº«å—ï¼Ÿ')) {
            return;
        }
        setStatus('æ­£åœ¨å–æ¶ˆåˆ†äº«...', 'info');
        try {
            const res = await fetch(endpoints.shareDelete, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ path })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || 'å–æ¶ˆåˆ†äº«å¤±è´¥');
            }
            delete shareMap[path];
            renderRows(currentItems);
            setStatus(data.message || 'åˆ†äº«å·²å–æ¶ˆ', 'success');
        } catch (error) {
            console.error(error);
            setStatus(error.message || 'å–æ¶ˆåˆ†äº«å¤±è´¥', 'error');
        }
    }

    async function copyShareLink(link) {
        if (!link) {
            setStatus('åˆ†äº«é“¾æ¥æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•', 'error');
            return;
        }
        try {
            await navigator.clipboard.writeText(link);
            setStatus('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } catch (error) {
            window.prompt('å¤åˆ¶åˆ†äº«é“¾æ¥', link);
        }
    }

    refreshBtn.addEventListener('click', refreshList);
    uploadBtn.addEventListener('click', uploadFile);
    mkdirBtn.addEventListener('click', createFolder);

    refreshList();
})();
</script>
{% endif %}
{% endblock %}
