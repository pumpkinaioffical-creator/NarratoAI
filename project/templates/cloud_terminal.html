{% extends "layout.html" %}
{% block title %}{{ _('云终端') }} - {{ _('南瓜AI') }}{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto pb-24 md:pb-12 space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ _('云终端控制台') }}</h1>
            <p class="text-sm text-gray-500 mt-1">{{ _('管理和执行远程 GPU 环境命令') }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Terminal Announcement -->
        {% if terminal_announcement and terminal_announcement.enabled and terminal_announcement.content %}
        <div class="lg:col-span-3">
            <div class="rounded-xl p-4 flex items-start gap-3 shadow-sm border
                {% if terminal_announcement.type == 'info' %}bg-blue-50 border-blue-100 text-blue-700
                {% elif terminal_announcement.type == 'success' %}bg-green-50 border-green-100 text-green-700
                {% elif terminal_announcement.type == 'warning' %}bg-yellow-50 border-yellow-100 text-yellow-700
                {% elif terminal_announcement.type == 'error' %}bg-red-50 border-red-100 text-red-700
                {% else %}bg-gray-50 border-gray-100 text-gray-700{% endif %}">
                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm font-medium">{{ terminal_announcement.content }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Adsterra Native Ad -->
        {% if settings.get('ads_enabled', False) and settings.get('adsterra_enabled', True) %}
        <div class="lg:col-span-3 flex justify-center">
             <script async="async" data-cfasync="false" src="//pl28129429.effectivegatecpm.com/35768f144f52938468363da0a29f1e25/invoke.js"></script>
            <div id="container-35768f144f52938468363da0a29f1e25"></div>
        </div>
        {% endif %}

        <!-- Main Terminal (Left, 2 cols) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Command Input Card -->
            <div class="glass rounded-3xl p-6 shadow-sm border border-gray-100 animate-fade-in-up">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-900 text-white p-2 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <h2 class="font-bold text-gray-900">{{ _('执行命令') }}</h2>
                    </div>
                </div>

                <!-- Target Selection -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">{{ _('目标环境') }}</label>
                        {% if session.get('logged_in') %}
                        <button type="button" id="refresh-targets" class="text-pumpkin-600 hover:text-pumpkin-700 transition-colors p-1 rounded-full hover:bg-pumpkin-50" title="{{ _('刷新列表') }}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                        {% endif %}
                    </div>

                    <div id="cloud-target-wrapper" class="flex flex-wrap gap-2">
                        {% if terminal_targets %}
                            {% for target in terminal_targets %}
                            <button type="button" class="chip-select group relative flex items-center gap-2 px-3 py-2 rounded-xl border transition-all text-left {% if loop.first %}border-pumpkin-500 bg-pumpkin-50 text-pumpkin-900 ring-1 ring-pumpkin-500{% else %}border-gray-200 bg-white text-gray-600 hover:border-pumpkin-300 hover:bg-gray-50{% endif %}" data-target="{{ target.name }}">
                                <span class="w-2 h-2 rounded-full {% if loop.first %}bg-pumpkin-500 animate-pulse{% else %}bg-gray-300 group-hover:bg-pumpkin-300{% endif %}"></span>
                                <div>
                                    <div class="text-sm font-bold">{{ target.name }}</div>
                                    {% if target.description %}
                                    <div class="text-[10px] opacity-70 leading-none mt-0.5">{{ target.description }}</div>
                                    {% endif %}
                                </div>
                            </button>
                            {% endfor %}
                        {% else %}
                            <div class="w-full bg-gray-50 border border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center text-gray-500 space-y-2">
                                <svg class="w-10 h-10 opacity-50 text-pumpkin-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                                <p class="text-sm font-medium text-gray-600 text-center">{{ _('你的云GPU机器正在启动中，请稍后再来。') }}</p>
                                <p class="text-xs text-gray-500 text-center">
                                    {{ _('有问题可联系站长') }}{% if settings.get('chat_enabled', True) %}，<a href="{{ url_for('main.chat') }}" class="text-pumpkin-600 underline hover:text-pumpkin-700 transition-colors font-bold">{{ _('点击跳转到聊天群聊') }}</a>{% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Input Area -->
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">{{ _('Shell 命令') }}</label>
                    <div class="relative">
                        <textarea id="cloud-terminal-command" class="w-full bg-gray-900 text-green-400 font-mono text-sm rounded-xl border-2 border-transparent focus:border-pumpkin-500 focus:ring-0 p-4 min-h-[120px] transition-all" placeholder="ls -la" {% if not session.get('logged_in') %}disabled style="opacity: 0.6; cursor: not-allowed;"{% endif %}></textarea>
                        <div class="absolute bottom-3 right-3 text-xs text-gray-500 font-mono">{{ _('CMD + ENTER to run') }}</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-3 mt-4">
                    {% if session.get('logged_in') %}
                    <button type="button" id="run-terminal-command" class="flex-1 bg-gradient-to-r from-pumpkin-500 to-rose-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-pumpkin-500/30 hover:shadow-pumpkin-500/50 transform hover:-translate-y-0.5 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>{{ _('执行命令') }}</span>
                    </button>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="flex-1 bg-gray-900 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:bg-black transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                        <span>{{ _('登录后执行') }}</span>
                    </a>
                    {% endif %}
                    <button type="button" id="clear-terminal-output" class="px-4 py-3 text-gray-500 font-medium hover:text-gray-900 hover:bg-gray-100 rounded-xl transition-colors">
                        {{ _('清空') }}
                    </button>
                </div>
            </div>

            <!-- Output Console -->
            <div class="glass rounded-3xl overflow-hidden shadow-sm border border-gray-100 flex flex-col min-h-[300px] animate-fade-in-up delay-100">
                <div class="bg-gray-50/80 backdrop-blur-sm border-b border-gray-100 p-3 flex justify-between items-center px-5">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                        <span class="ml-3 text-xs font-mono text-gray-500" id="terminal-meta">{{ _('等待输入...') }}</span>
                    </div>
                    <span id="terminal-status-badge" class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase bg-gray-200 text-gray-500">
                        IDLE
                    </span>
                </div>
                <div class="relative flex-1 bg-[#1e1e1e]">
                    <pre id="cloud-terminal-output" class="absolute inset-0 p-4 overflow-auto font-mono text-sm text-gray-300 whitespace-pre-wrap">$ ready_</pre>
                </div>
            </div>
        </div>

        <!-- Sidebar (Right, 1 col) -->
        <div class="space-y-6">
            <!-- Stats -->
            <div class="glass rounded-3xl p-6 shadow-sm border border-gray-100 animate-fade-in-up delay-200">
                <h3 class="font-bold text-gray-900 mb-4">{{ _('本次运行详情') }}</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Run ID</span>
                        <span id="detail-run-id" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded text-gray-700">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">{{ _('耗时') }}</span>
                        <span id="detail-runtime" class="font-mono text-xs text-gray-900 font-bold">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">{{ _('网络延迟') }}</span>
                        <span id="detail-proxy" class="font-mono text-xs text-gray-900">-</span>
                    </div>
                </div>
            </div>

            <!-- Adsterra Banner (Sidebar) -->
            {% if settings.get('ads_enabled', False) and settings.get('adsterra_enabled', True) %}
            <div class="glass rounded-3xl p-4 shadow-sm border border-gray-100 flex justify-center overflow-hidden">
                <script type="text/javascript">
                    atOptions = { 'key' : 'a14ef6076862566f9c651879709b29b5', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/a14ef6076862566f9c651879709b29b5/invoke.js"></script>
            </div>
            {% endif %}

            <!-- History -->
            <div class="glass rounded-3xl p-6 shadow-sm border border-gray-100 animate-fade-in-up delay-300">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="font-bold text-gray-900">{{ _('执行历史') }}</h3>
                </div>
                <div id="cloud-terminal-history" class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- History items will be injected here -->
                    <div class="text-center py-8 text-gray-400 text-sm">
                        {{ _('暂无历史记录') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const commandInput = document.getElementById('cloud-terminal-command');
    const runButton = document.getElementById('run-terminal-command');
    const clearButton = document.getElementById('clear-terminal-output');
    const outputEl = document.getElementById('cloud-terminal-output');
    const metaEl = document.getElementById('terminal-meta');
    const statusBadge = document.getElementById('terminal-status-badge');
    const detailCommand = document.getElementById('detail-command');
    const detailRunId = document.getElementById('detail-run-id');
    const detailRuntime = document.getElementById('detail-runtime');
    const detailProxy = document.getElementById('detail-proxy');
    const historyContainer = document.getElementById('cloud-terminal-history');
    const terminalTargets = {{ terminal_targets | tojson | safe }};
    const targetWrapper = document.getElementById('cloud-target-wrapper');
    const refreshTargetsBtn = document.getElementById('refresh-targets');

    let currentTarget = terminalTargets.length ? terminalTargets[0].name : '';

    function updateTargetButtonStates() {
        document.querySelectorAll('.chip-select').forEach(btn => {
            const isActive = btn.dataset.target === currentTarget;
            // Reset classes
            btn.className = `chip-select group relative flex items-center gap-2 px-3 py-2 rounded-xl border transition-all text-left ${isActive ? 'border-pumpkin-500 bg-pumpkin-50 text-pumpkin-900 ring-1 ring-pumpkin-500' : 'border-gray-200 bg-white text-gray-600 hover:border-pumpkin-300 hover:bg-gray-50'}`;

            // Update dot
            const dot = btn.querySelector('span');
            if (dot) {
                dot.className = `w-2 h-2 rounded-full ${isActive ? 'bg-pumpkin-500 animate-pulse' : 'bg-gray-300 group-hover:bg-pumpkin-300'}`;
            }
        });
    }

    function setTarget(targetName) {
        currentTarget = targetName;
        updateTargetButtonStates();
    }

    if (targetWrapper) {
        targetWrapper.addEventListener('click', (event) => {
            const button = event.target.closest('.chip-select');
            if (button?.dataset.target) {
                setTarget(button.dataset.target);
            }
        });
    }

    if (currentTarget) setTarget(currentTarget);

    async function refreshAppList() {
        try {
            const btnIcon = refreshTargetsBtn?.querySelector('svg');
            if (btnIcon) btnIcon.classList.add('animate-spin');

            const response = await fetch('{{ url_for("api.list_cloud_terminal_apps") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await response.json();

            if (data.success && data.apps.length > 0) {
                terminalTargets.length = 0;
                data.apps.forEach(app => {
                    terminalTargets.push({ name: app.name, description: app.description || '' });
                });

                if (targetWrapper) {
                    targetWrapper.innerHTML = '';
                    terminalTargets.forEach((target, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'chip-select'; // Initial generic class, updated by updateTargetButtonStates
                        btn.dataset.target = target.name;

                        btn.innerHTML = `
                            <span class="w-2 h-2 rounded-full"></span>
                            <div>
                                <div class="text-sm font-bold">${target.name}</div>
                                ${target.description ? `<div class="text-[10px] opacity-70 leading-none mt-0.5">${target.description}</div>` : ''}
                            </div>
                        `;
                        targetWrapper.appendChild(btn);
                    });

                    if (!currentTarget || !terminalTargets.find(t => t.name === currentTarget)) {
                        setTarget(terminalTargets[0].name);
                    } else {
                        updateTargetButtonStates();
                    }
                }
            } else {
                 if (targetWrapper) {
                    targetWrapper.innerHTML = `
                        <div class="w-full bg-gray-50 border border-dashed border-gray-300 rounded-xl p-4 flex flex-col items-center justify-center text-gray-500">
                            <span class="text-sm">未检测到环境</span>
                        </div>`;
                 }
            }
            if (btnIcon) btnIcon.classList.remove('animate-spin');
        } catch (e) {
            console.error("Failed to refresh app list", e);
            const btnIcon = refreshTargetsBtn?.querySelector('svg');
            if (btnIcon) btnIcon.classList.remove('animate-spin');
        }
    }

    refreshTargetsBtn?.addEventListener('click', refreshAppList);

    function updateBadge(state) {
        statusBadge.textContent = state;
        statusBadge.className = 'px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ';
        if (state === '运行中') statusBadge.classList.add('bg-blue-100', 'text-blue-700', 'animate-pulse');
        else if (state === '成功') statusBadge.classList.add('bg-green-100', 'text-green-700');
        else if (state === '失败') statusBadge.classList.add('bg-red-100', 'text-red-700');
        else statusBadge.classList.add('bg-gray-200', 'text-gray-500');
    }

    function appendHistory(entry) {
        // Clear empty state if exists
        if (historyContainer.children.length === 1 && historyContainer.children[0].textContent.includes('暂无')) {
            historyContainer.innerHTML = '';
        }

        const item = document.createElement('div');
        item.className = `p-3 rounded-xl border text-left text-sm ${entry.success ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`;

        item.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <span class="font-mono font-bold ${entry.success ? 'text-green-800' : 'text-red-800'}">${entry.command}</span>
                <span class="text-[10px] text-gray-400 ml-2">${entry.time}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-[10px] bg-white/50 px-1.5 py-0.5 rounded text-gray-600 border border-gray-100">${entry.variant}</span>
                <span class="text-[10px] font-medium ${entry.success ? 'text-green-600' : 'text-red-600'}">${entry.success ? '成功' : '失败'} (Code ${entry.returncode ?? '-'})</span>
            </div>
        `;

        historyContainer.prepend(item);
        if (historyContainer.children.length > 8) {
            historyContainer.removeChild(historyContainer.lastChild);
        }
    }

    async function executeCommand(commandOverride, targetOverride) {
        const providedCommand = (commandOverride ?? commandInput.value).trim();
        if (targetOverride && targetOverride !== currentTarget) setTarget(targetOverride);
        const targetUsed = targetOverride || currentTarget || '';

        if (!providedCommand) {
            metaEl.textContent = '请输入命令...';
            metaEl.className = 'ml-3 text-xs font-mono text-red-500';
            return;
        }
        if (!targetUsed && terminalTargets.length) {
            metaEl.textContent = '请先选择一个目标环境';
            metaEl.className = 'ml-3 text-xs font-mono text-red-500';
            return;
        }

        // Reset UI
        runButton.disabled = true;
        runButton.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> <span>执行中...</span>';
        updateBadge('运行中');
        metaEl.className = 'ml-3 text-xs font-mono text-blue-500';
        metaEl.textContent = '正在发送命令...';

        try {
            const response = await fetch('{{ url_for("api.proxy_cloud_terminal_command") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: providedCommand, target: targetUsed })
            });
            const payload = await response.json();
            const remote = payload.payload || {};
            const result = remote.result || remote;

            if (!response.ok || !payload.success) {
                const summary = payload.error || '远程服务错误';
                updateBadge('失败');
                metaEl.textContent = 'Error: ' + summary;
                metaEl.className = 'ml-3 text-xs font-mono text-red-500';
                outputEl.textContent = JSON.stringify(remote, null, 2);
                appendHistory({
                    command: providedCommand,
                    time: new Date().toLocaleTimeString(),
                    variant: targetUsed,
                    success: false,
                    returncode: payload.status_code,
                    summary
                });
                return;
            }

            const stdout = result.stdout || '';
            const stderr = result.stderr || remote.stderr || '';
            const outputBody = `$ ${result.command || providedCommand}\n${stdout}${stderr ? `\n\n=== STDERR ===\n${stderr}` : ''}`.trim() || '(No Output)';

            outputEl.textContent = outputBody;

            // Update Details
            if (detailRunId) detailRunId.textContent = remote.run_id || 'N/A';
            if (detailRuntime) detailRuntime.textContent = (result.run_time_ms ? Number(result.run_time_ms).toFixed(2) : '0') + ' ms';
            if (detailProxy) detailProxy.textContent = (payload.proxy_latency_ms || '0') + ' ms';

            const success = result.success !== false;
            updateBadge(success ? '成功' : '失败');
            metaEl.textContent = success ? '执行成功' : '执行遇到错误';
            metaEl.className = `ml-3 text-xs font-mono ${success ? 'text-green-500' : 'text-yellow-500'}`;

            appendHistory({
                command: result.command || providedCommand,
                time: new Date().toLocaleTimeString(),
                variant: targetUsed,
                success,
                returncode: result.returncode
            });

        } catch (error) {
            updateBadge('失败');
            metaEl.textContent = '系统错误';
            outputEl.textContent = error.stack || error.message;
        } finally {
            runButton.disabled = false;
            runButton.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>执行命令</span>';
        }
    }

    runButton?.addEventListener('click', () => executeCommand());
    clearButton?.addEventListener('click', () => {
        outputEl.textContent = '$ ready_';
        metaEl.textContent = '输出已清空';
        updateBadge('IDLE');
    });

    commandInput?.addEventListener('keydown', (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
            event.preventDefault();
            executeCommand();
        }
    });
});
</script>
{% endblock %}
